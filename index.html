<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>æ€åŠ¿æ¨æ¼”æ²™ç›˜ï¼ˆHUD + æ—¶é—´è½´ + æ¨æ¼”æ¨¡å¼ï¼‰</title>

  <link href="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.css" rel="stylesheet" />
  <script src="https://unpkg.com/maplibre-gl@3.6.1/dist/maplibre-gl.js"></script>

  <style>
    :root{
      --hud: rgba(0,0,0,.55);
      --hud-border: rgba(0,255,180,.25);
      --mint: #7fffd4;
      --text: #e6fff7;
      --muted: #9adfd0;
      --alert: #ff4d4f;
    }

    html, body{ margin:0; height:100%; background:#000; }
    #map{ width:100vw; height:100vh; filter: brightness(.78) contrast(1.18) saturate(.86); }

    /* ===== HUD é¡¶æ  ===== */
    #hud-topbar{
      position:fixed; left:12px; right:12px; top:10px; z-index:9999;
      display:flex; gap:10px; align-items:center; pointer-events:none;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      color:var(--mint); font-size:12px;
    }
    .hud-pill{
      padding:6px 10px; border:1px solid var(--hud-border);
      background:rgba(0,0,0,.45); border-radius:10px;
    }
    #hud-clock{
      margin-left:auto;
      padding:6px 10px; border:1px solid var(--hud-border);
      background:rgba(0,0,0,.55); border-radius:10px;
      color:var(--text);
    }

    /* ===== HUD è¦†ç›–å±‚ï¼šç½‘æ ¼ + æ‰«æçº¿ ===== */
    #hud-grid{
      position:fixed; inset:0; z-index:9997; pointer-events:none;
      background-image:
        linear-gradient(rgba(0,255,180,.08) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0,255,180,.08) 1px, transparent 1px);
      background-size: 40px 40px;
      mix-blend-mode: screen;
      opacity:.35;
    }
    #hud-scanline{
      position:fixed; inset:-200% 0 0 0; z-index:9998; pointer-events:none;
      background: linear-gradient(to bottom, transparent 0%, rgba(0,255,180,.10) 50%, transparent 100%);
      height:120px;
      animation: scan 6s linear infinite;
      opacity:.35;
    }
    @keyframes scan{
      from{ transform: translateY(-30vh); }
      to{ transform: translateY(130vh); }
    }

    /* ===== å·¦ä¾§æƒ…æŠ¥é¢æ¿ ===== */
    #intel-panel{
      position:fixed;
      left:16px;
      top:70px;
      width:340px;
      max-height:74vh;
      z-index:9999;
      background:var(--hud);
      border:1px solid var(--hud-border);
      border-radius:14px;
      padding:14px;
      backdrop-filter: blur(6px);
      color:var(--text);
      font-size:12px;
      overflow:hidden;
    }
    .intel-title{
      font-size:14px;
      font-weight:700;
      letter-spacing:.08em;
      margin-bottom:6px;
      color:var(--mint);
      font-family: ui-monospace, monospace;
    }
    .intel-sub{ color:var(--muted); margin-bottom:10px; }

    .intel-row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-bottom:10px; }
    .btn{
      padding:8px 10px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.45);
      color:var(--text);
      border-radius:10px;
      font-size:12px;
      cursor:pointer;
      user-select:none;
    }
    .btn:hover{ border-color: rgba(127,255,212,.35); }
    .btn-active{
      border-color: rgba(127,255,212,.65);
      box-shadow: 0 0 0 1px rgba(127,255,212,.18) inset;
    }
    .range{
      width:100%;
      accent-color: var(--mint);
    }
    .small{ color:var(--muted); font-size:12px; }

    .intel-section{
      border-top:1px solid rgba(0,255,180,.18);
      padding-top:10px;
      margin-top:10px;
    }
    .intel-sec-title{
      color:var(--mint);
      margin-bottom:6px;
      font-family: ui-monospace, monospace;
    }
    #eventLog{
      max-height:280px;
      overflow:auto;
      font-family: ui-monospace, monospace;
    }
    .log-item{
      padding:6px 8px;
      border-bottom:1px solid rgba(255,255,255,.06);
      color:#ddd;
    }
    .log-alert{ color: var(--alert); }

    /* ===== åœ°å›¾å¼¹å‡ºå‘Šè­¦å¡ ===== */
    .alert-card{
      background:rgba(120,0,0,.85);
      border:1px solid var(--alert);
      color:#fff;
      padding:10px 12px;
      border-radius:10px;
      font-size:12px;
      min-width:240px;
      box-shadow:0 8px 24px rgba(0,0,0,.45);
      font-family: ui-monospace, monospace;
    }

    /* ===== å•ä½ Markerï¼ˆå›½æ—— + æ ‡ç­¾ + æœå‘ç®­å¤´ï¼‰ ===== */
    .unit-marker{
      display:flex;
      align-items:center;
      gap:6px;
      background:rgba(0,0,0,.55);
      border:1px solid;
      padding:6px 8px;
      border-radius:10px;
      backdrop-filter: blur(4px);
      transform-origin: center;
    }
    .unit-marker img{ width:18px; height:18px; border-radius:3px; }
    .unit-label{ color:var(--text); font-size:12px; white-space:nowrap; }
    .unit-heading{
      width:0;height:0;
      border-left:6px solid transparent;
      border-right:6px solid transparent;
      border-bottom:10px solid var(--mint);
      opacity:.9;
      margin-right:2px;
      transform-origin: 50% 70%;
    }

    /* è®© marker ä¸è¢« HUD å±‚æŒ¡ä½ */
    .maplibregl-popup{ z-index: 10000; }
  </style>
</head>

<body>
  <div id="map"></div>

  <div id="hud-topbar">
    <span class="hud-pill">TACTICAL VIEW</span>
    <span class="hud-pill">SAT_UPLINK: STABLE</span>
    <span class="hud-pill">OP_AREA: WEST PACIFIC</span>
    <span id="hud-clock">--</span>
  </div>
  <div id="hud-grid"></div>
  <div id="hud-scanline"></div>

  <div id="intel-panel">
    <div class="intel-title">INTELLIGENCE</div>
    <div class="intel-sub">â–¶ æ‹–åŠ¨æ—¶é—´è½´å›æ”¾ï¼›åˆ‡æ¢äº‹å®/æ¨æ¼”ï¼›äº‹ä»¶ä¼šè‡ªåŠ¨èšç„¦ä¸å‘Šè­¦ã€‚</div>

    <div class="intel-row">
      <button id="btnFact" class="btn btn-active">äº‹å®</button>
      <button id="btnSim" class="btn">æ¨æ¼”</button>
      <button id="btnPlay" class="btn">æ’­æ”¾</button>
      <button id="btnPause" class="btn">æš‚åœ</button>
    </div>

    <div class="small" id="modeHint">æ¨¡å¼ï¼šäº‹å®ï¼ˆå®çº¿èˆªè¿¹ï¼‰</div>
    <div style="height:8px"></div>
    <input id="timeRange" class="range" type="range" min="0" max="1000" step="1" value="1000" />
    <div class="small" id="timeLabel">æ—¶é—´ï¼š--</div>

    <div class="intel-section">
      <div class="intel-sec-title">EVENT LOG</div>
      <div id="eventLog"></div>
    </div>
  </div>

<script>
  /* ========= 0) åŸºç¡€ï¼šMapLibre åˆå§‹åŒ– ========= */
  const map = new maplibregl.Map({
    container: "map",
    style: "https://demotiles.maplibre.org/style.json",
    center: [125, 22],
    zoom: 4
  });
  map.addControl(new maplibregl.NavigationControl({ visualizePitch: true }), "top-right");

  /* ========= 1) ç±»å‹æ ·å¼ï¼ˆèˆ°/æœº/æµ·è­¦/å•†èˆ¹ï¼‰ ========= */
  const TYPE_STYLE = {
    ship:       { color:"#ff4d4f", label:"èˆ°" },
    aircraft:   { color:"#ffa940", label:"æœº" },
    coastguard: { color:"#52c41a", label:"æµ·è­¦" },
    merchant:   { color:"#40a9ff", label:"å•†èˆ¹" }
  };

  /* ========= 2) å·¥å…·å‡½æ•°ï¼šæ—¶é—´/æ’å€¼/èˆªå‘ ========= */
  const ms = (iso)=>Date.parse(iso);
  const lerp = (a,b,t)=>a+(b-a)*t;
  const lerpCoord = (c1,c2,t)=>[ lerp(c1[0],c2[0],t), lerp(c1[1],c2[1],t) ];

  // æ ¹æ® tMs åœ¨å¸¦æ—¶é—´ç‚¹åˆ—ä¸­æ’å€¼ä½ç½®
  function positionAt(points, tMs){
    if (!points?.length) return null;
    const arr = points.map(p=>({m:ms(p.t), c:p.c})).sort((x,y)=>x.m-y.m);
    if (tMs <= arr[0].m) return arr[0].c;
    if (tMs >= arr[arr.length-1].m) return arr[arr.length-1].c;
    for (let i=0;i<arr.length-1;i++){
      const a=arr[i], b=arr[i+1];
      if (tMs>=a.m && tMs<=b.m){
        const r=(tMs-a.m)/((b.m-a.m)||1);
        return lerpCoord(a.c,b.c,r);
      }
    }
    return arr[arr.length-1].c;
  }

  // æˆªå–å·²èµ°è¿‡è½¨è¿¹ï¼ˆç”¨äºç”»èˆªè¿¹ï¼‰
  function trackSlice(points, tMs){
    const arr = points.map(p=>({m:ms(p.t), c:p.c})).sort((x,y)=>x.m-y.m);
    const out = [];
    for (const p of arr){ if (p.m <= tMs) out.push(p.c); }
    const cur = positionAt(points, tMs);
    if (cur && (!out.length || out[out.length-1][0]!==cur[0] || out[out.length-1][1]!==cur[1])) out.push(cur);
    return out.length>=2 ? out : null;
  }

  // è®¡ç®—èˆªå‘è§’ï¼ˆåº¦ï¼‰ï¼šä» c1 æŒ‡å‘ c2
  function bearingDeg(c1, c2){
    const lon1 = c1[0]*Math.PI/180, lat1 = c1[1]*Math.PI/180;
    const lon2 = c2[0]*Math.PI/180, lat2 = c2[1]*Math.PI/180;
    const dLon = lon2 - lon1;
    const y = Math.sin(dLon) * Math.cos(lat2);
    const x = Math.cos(lat1)*Math.sin(lat2) - Math.sin(lat1)*Math.cos(lat2)*Math.cos(dLon);
    let brng = Math.atan2(y, x) * 180/Math.PI;
    brng = (brng + 360) % 360;
    return brng;
  }

  /* ========= 3) å›½æ——å›¾æ ‡ï¼ˆTwemoji SVGï¼Œä¸éœ€è¦ä½ ä¸Šä¼ å›¾ç‰‡ï¼‰ ========= */
  function twemojiUrl(emoji) {
    const codePoints = Array.from(emoji).map(ch => ch.codePointAt(0).toString(16)).join("-");
    return `https://cdn.jsdelivr.net/gh/twitter/twemoji@14.0.2/assets/svg/${codePoints}.svg`;
  }

  function makeUnitEl(unit){
    const st = TYPE_STYLE[unit.type] || { color:"#aaa", label:"?" };
    const el = document.createElement("div");
    el.className = "unit-marker";
    el.style.borderColor = st.color;

    // æœå‘ç®­å¤´ï¼šç‹¬ç«‹å…ƒç´ ï¼Œé¿å…æ•´ä½“æ—‹è½¬å½±å“æ–‡å­—
    const heading = document.createElement("div");
    heading.className = "unit-heading";
    heading.style.borderBottomColor = st.color;

    const img = document.createElement("img");
    img.src = twemojiUrl(unit.flag);

    const label = document.createElement("div");
    label.className = "unit-label";
    label.innerHTML = `<span style="color:${st.color};font-weight:700">[${st.label}]</span> ${unit.name}`;

    el.appendChild(heading);
    el.appendChild(img);
    el.appendChild(label);

    // å­˜ä¸ªå¼•ç”¨æ–¹ä¾¿æ›´æ–°æ—‹è½¬
    el._headingEl = heading;
    return el;
  }

  /* ========= 4) æ•°æ®ï¼šäº‹å®è½¨è¿¹ + æ¨æ¼”è½¨è¿¹ï¼ˆç¤ºä¾‹ï¼‰ =========
     ä½ åç»­åªéœ€è¦æŠŠ pointsFact/pointsSim æ¢æˆçœŸå®æ•°æ®ï¼ˆ90å¤©ï¼‰ */
  const unitTracks = [
    {
      id:"us_ddg113", name:"US DDG-113", flag:"ğŸ‡ºğŸ‡¸", type:"ship",
      pointsFact:[
        {t:"2025-09-13T00:00:00Z", c:[121.0, 17.0]},
        {t:"2025-10-01T00:00:00Z", c:[123.2, 18.1]},
        {t:"2025-11-01T00:00:00Z", c:[126.5, 20.0]},
        {t:"2025-12-12T00:00:00Z", c:[129.2, 22.0]}
      ],
      pointsSim:[
        {t:"2025-09-13T00:00:00Z", c:[121.0, 17.0]},
        {t:"2025-10-15T00:00:00Z", c:[124.5, 18.8]},
        {t:"2025-11-20T00:00:00Z", c:[127.2, 21.0]},
        {t:"2025-12-12T00:00:00Z", c:[131.0, 23.2]}
      ]
    },
    {
      id:"jp_p3c", name:"P-3C", flag:"ğŸ‡¯ğŸ‡µ", type:"aircraft",
      pointsFact:[
        {t:"2025-10-20T00:00:00Z", c:[124.0, 20.8]},
        {t:"2025-11-09T20:02:00Z", c:[125.4, 21.0]},
        {t:"2025-12-10T00:00:00Z", c:[126.0, 20.7]}
      ],
      pointsSim:[
        {t:"2025-10-20T00:00:00Z", c:[124.0, 20.8]},
        {t:"2025-11-10T10:00:00Z", c:[126.2, 21.4]},
        {t:"2025-12-10T00:00:00Z", c:[127.0, 20.9]}
      ]
    },
    {
      id:"cn_cg5402", name:"CCG 5402", flag:"ğŸ‡¨ğŸ‡³", type:"coastguard",
      pointsFact:[
        {t:"2025-09-20T00:00:00Z", c:[123.0, 25.7]},
        {t:"2025-10-25T00:00:00Z", c:[123.6, 25.9]},
        {t:"2025-11-16T00:00:00Z", c:[123.5, 25.9]},
        {t:"2025-12-12T00:00:00Z", c:[123.2, 25.6]}
      ],
      pointsSim:[
        {t:"2025-09-20T00:00:00Z", c:[123.0, 25.7]},
        {t:"2025-11-05T00:00:00Z", c:[124.2, 26.1]},
        {t:"2025-12-12T00:00:00Z", c:[125.0, 26.6]}
      ]
    },
    {
      id:"mv_evergreen", name:"EVERGREEN", flag:"ğŸ‡µğŸ‡¦", type:"merchant",
      pointsFact:[
        {t:"2025-09-15T00:00:00Z", c:[118.0, 22.3]},
        {t:"2025-10-18T00:00:00Z", c:[120.5, 20.9]},
        {t:"2025-11-25T00:00:00Z", c:[123.0, 19.2]},
        {t:"2025-12-12T00:00:00Z", c:[125.5, 18.0]}
      ],
      pointsSim:[
        {t:"2025-09-15T00:00:00Z", c:[118.0, 22.3]},
        {t:"2025-10-20T00:00:00Z", c:[121.8, 21.2]},
        {t:"2025-12-12T00:00:00Z", c:[127.2, 19.0]}
      ]
    }
  ];

  /* ========= 5) äº‹ä»¶ï¼ˆæŒ‰çœŸå®æ—¶é—´è§¦å‘ï¼šäº‹å®/æ¨æ¼”å¯å…±äº«ï¼Œä¹Ÿå¯åˆ†å¼€ï¼‰ ========= */
  const scenarioEvents = [
    { t:"2025-11-09T20:02:00Z", unitId:"jp_p3c", title:"æŠµè¿‘ä¾¦å¯Ÿ", desc:"æ—¥æ–¹ P-3C æŒç»­è·Ÿè¸ªç›‘è§†", level:"ALERT" },
    { t:"2025-11-10T02:00:00Z", unitId:"us_ddg113", title:"æµ·åŸŸä»‹å…¥", desc:"ç¾èˆ° DDG-113 è¿›å…¥ç›¸å…³æµ·åŸŸ", level:"ALERT" },
    { t:"2025-11-16T00:00:00Z", unitId:"cn_cg5402", title:"æµ·è­¦å·¡èˆª", desc:"äº‰è®®æµ·åŸŸæµ·è­¦æ´»åŠ¨å¼•å‘èˆ†è®ºå‡æ¸©", level:"INFO" }
  ].map(e=>({ ...e, m: ms(e.t) }));

  /* ========= 6) UI & çŠ¶æ€ ========= */
  const eventLog = document.getElementById("eventLog");
  const timeRangeEl = document.getElementById("timeRange");
  const timeLabelEl = document.getElementById("timeLabel");
  const modeHintEl = document.getElementById("modeHint");
  const hudClockEl = document.getElementById("hud-clock");

  const btnFact = document.getElementById("btnFact");
  const btnSim  = document.getElementById("btnSim");
  const btnPlay = document.getElementById("btnPlay");
  const btnPause= document.getElementById("btnPause");

  let mode = "fact";       // "fact" | "sim"
  let playing = false;
  let currentT = null;
  const fired = new Set();

  function addLog(text, isAlert=false){
    const div = document.createElement("div");
    div.className = "log-item" + (isAlert ? " log-alert" : "");
    div.textContent = text;
    eventLog.prepend(div);
  }

  function showAlertOnMap(lngLat, title, desc){
    new maplibregl.Popup({ closeButton:true, closeOnClick:true, maxWidth:"320px" })
      .setLngLat(lngLat)
      .setHTML(`
        <div class="alert-card">
          <div style="font-weight:700;margin-bottom:6px">âš  ALERTï¼š${title}</div>
          <div style="opacity:.95">${desc}</div>
        </div>
      `)
      .addTo(map);
  }

  function setClock(tMs){
    const d = new Date(tMs);
    const s = d.toISOString().replace("T"," ").slice(0,19) + " UTC";
    hudClockEl.textContent = s;
    timeLabelEl.textContent = "æ—¶é—´ï¼š" + s;
  }

  function setMode(next){
    mode = next;
    btnFact.classList.toggle("btn-active", mode==="fact");
    btnSim.classList.toggle("btn-active", mode==="sim");
    modeHintEl.textContent = mode==="fact" ? "æ¨¡å¼ï¼šäº‹å®ï¼ˆå®çº¿èˆªè¿¹ï¼‰" : "æ¨¡å¼ï¼šæ¨æ¼”ï¼ˆè™šçº¿èˆªè¿¹ï¼‰";

    // è½¨è¿¹çº¿å‹åˆ‡æ¢
    if (map.getLayer("unit-trails-line")){
      map.setPaintProperty("unit-trails-line", "line-dasharray", mode==="fact" ? [1,0] : [2,2]);
      map.setPaintProperty("unit-trails-line", "line-opacity", mode==="fact" ? 0.75 : 0.85);
      map.setPaintProperty("unit-trails-line", "line-color", mode==="fact" ? "#40a9ff" : "#ff4d4f");
    }
    // åˆ‡æ¢åé‡æ–°åˆ·æ–°ï¼ˆä½ç½®/è½¨è¿¹ï¼‰
    updateAt(currentT, {refire:false});
  }

  btnFact.onclick = ()=>setMode("fact");
  btnSim.onclick  = ()=>setMode("sim");
  btnPlay.onclick = ()=>{ playing = true; };
  btnPause.onclick= ()=>{ playing = false; };

  /* ========= 7) å…¨å±€æ—¶é—´èŒƒå›´ï¼ˆä»æ‰€æœ‰è½¨è¿¹æŠ½å–ï¼‰ ========= */
  function getAllTimes(){
    const times=[];
    for (const u of unitTracks){
      const pts = (mode==="fact" ? u.pointsFact : u.pointsSim);
      pts.forEach(p=>times.push(ms(p.t)));
    }
    times.sort((a,b)=>a-b);
    return times;
  }

  /* ========= 8) å•ä½ Marker + èˆªè¿¹ Source ========= */
  const unitMarkers = new Map(); // id -> { marker, el }
  const trailFC = { type:"FeatureCollection", features: [] };

  function pointsForUnit(u){
    return (mode==="fact" ? u.pointsFact : u.pointsSim);
  }

  function rebuildTrails(tMs){
    trailFC.features = unitTracks.map(u=>{
      const coords = trackSlice(pointsForUnit(u), tMs) || [];
      return {
        type:"Feature",
        properties:{ id:u.id, name:u.name, type:u.type },
        geometry:{ type:"LineString", coordinates: coords }
      };
    });
    map.getSource("unit-trails").setData(trailFC);
  }

  // ç”¨äºäº‹ä»¶èšç„¦çš„é«˜äº®ç‚¹
  const focusFC = { type:"FeatureCollection", features: [] };
  let focusPulseTimer = null;

  function focusPulseAt(lngLat){
    focusFC.features = [{
      type:"Feature",
      properties:{},
      geometry:{ type:"Point", coordinates:[lngLat.lng, lngLat.lat] }
    }];
    map.getSource("focus-point").setData(focusFC);

    // ç®€å•è„‰å†²åŠ¨ç”»ï¼šæ”¹ circle-radius
    let r=6, dir=1;
    if (focusPulseTimer) clearInterval(focusPulseTimer);
    focusPulseTimer = setInterval(()=>{
      r += dir*1.2;
      if (r > 26) dir = -1;
      if (r < 8) dir = 1;
      if (map.getLayer("focus-ring")) map.setPaintProperty("focus-ring", "circle-radius", r);
    }, 60);

    // 3ç§’ååœæ­¢è„‰å†²ä½†ä¿ç•™ä¸€ä¸‹é«˜äº®ï¼Œç„¶åæ·¡å‡º
    setTimeout(()=>{
      if (focusPulseTimer) clearInterval(focusPulseTimer);
      focusPulseTimer = null;
      // é€æ­¥æ·¡å‡º
      let op=0.85;
      const fade = setInterval(()=>{
        op -= 0.08;
        if (op <= 0){
          clearInterval(fade);
          focusFC.features = [];
          map.getSource("focus-point").setData(focusFC);
          return;
        }
        if (map.getLayer("focus-ring")) map.setPaintProperty("focus-ring", "circle-opacity", op);
      }, 80);
    }, 3000);
  }

  function fireEventsIfNeeded(tMs){
    // è¿™é‡Œï¼šäº‹ä»¶ä¸åŒºåˆ†äº‹å®/æ¨æ¼”ï¼›å¦‚æœä½ æƒ³åŒºåˆ†ï¼Œå¯ç»™äº‹ä»¶åŠ  mode å­—æ®µè¿‡æ»¤
    scenarioEvents.forEach((ev, idx)=>{
      if (fired.has(idx)) return;
      if (tMs >= ev.m){
        fired.add(idx);
        const mk = unitMarkers.get(ev.unitId)?.marker;
        if (!mk) return;
        const pos = mk.getLngLat();

        const isAlert = (ev.level === "ALERT");
        addLog(`${ev.level}ï¼š${ev.title} - ${ev.desc}`, isAlert);
        if (isAlert) showAlertOnMap(pos, ev.title, ev.desc);

        // C) äº‹ä»¶èšç„¦ï¼šflyTo + é«˜äº®è„‰å†²
        map.flyTo({
          center: [pos.lng, pos.lat],
          zoom: 6.2,
          speed: 0.9,
          curve: 1.2,
          essential: true
        });
        focusPulseAt(pos);
      }
    });
  }

  /* ========= 9) æ ¸å¿ƒæ›´æ–°ï¼šä½ç½®/æœå‘/èˆªè¿¹/äº‹ä»¶ ========= */
  function updateAt(tMs, opt={refire:true}){
    if (!tMs) return;
    currentT = tMs;
    setClock(tMs);

    for (const u of unitTracks){
      const pts = pointsForUnit(u);
      const pos = positionAt(pts, tMs);
      if (!pos) continue;

      const entry = unitMarkers.get(u.id);
      entry.marker.setLngLat(pos);

      // A) æœå‘ï¼šç”¨ä¸€ä¸ªå°æ—¶é—´å¢é‡è®¡ç®— bearing
      const dt = 60 * 60 * 1000; // 1å°æ—¶
      const p1 = positionAt(pts, Math.max(tMs - dt, ms(pts[0].t)));
      const p2 = positionAt(pts, Math.min(tMs + dt, ms(pts[pts.length-1].t)));
      const br = (p1 && p2) ? bearingDeg(p1, p2) : 0;
      // åªæ—‹è½¬ç®­å¤´ï¼Œä¸æ—‹è½¬æ–‡å­—/æ——å¸œ
      entry.el._headingEl.style.transform = `rotate(${br}deg)`;
    }

    rebuildTrails(tMs);
    fireEventsIfNeeded(tMs);
  }

  /* ========= 10) æ—¶é—´è½´ï¼ˆ0..1000 -> tMin..tMaxï¼‰ & æ’­æ”¾ ========= */
  function computeRange(){
    const times = getAllTimes();
    return { tMin: times[0], tMax: times[times.length-1] };
  }
  let { tMin, tMax } = computeRange();

  timeRangeEl.oninput = ()=>{
    playing = false;
    const k = Number(timeRangeEl.value)/1000;
    const t = tMin + (tMax - tMin) * k;
    updateAt(t);
  };

  function loop(){
    if (playing){
      // æ’­æ”¾é€Ÿåº¦ï¼šæ¯ç§’æ¨è¿› 6å°æ—¶ï¼ˆå¯è°ƒï¼‰
      const speedMsPerSec = 6 * 3600 * 1000;
      currentT += speedMsPerSec / 60; // çº¦æŒ‰ 60fps
      if (currentT >= tMax){
        currentT = tMax;
        playing = false;
      }
      const k = (currentT - tMin)/(tMax - tMin);
      timeRangeEl.value = String(Math.round(k*1000));
      updateAt(currentT);
    }
    requestAnimationFrame(loop);
  }

  /* ========= 11) åœ°å›¾åŠ è½½åï¼šåˆ›å»º Markerã€è½¨è¿¹å±‚ã€é«˜äº®å±‚ ========= */
  map.on("load", ()=>{
    // è½¨è¿¹å±‚ï¼šæ¯ä¸ªå•ä½ä¸€æ¡çº¿ï¼ˆé¢œè‰²å¯æ‰©å±•åˆ°æŒ‰ç±»å‹/æŒ‰é˜µè¥ï¼‰
    map.addSource("unit-trails", { type:"geojson", data: trailFC });
    map.addLayer({
      id:"unit-trails-line",
      type:"line",
      source:"unit-trails",
      paint:{
        "line-color":"#40a9ff",
        "line-width":2,
        "line-opacity":0.75,
        "line-dasharray":[1,0] // äº‹å®=å®çº¿ï¼›æ¨æ¼”ä¼šåˆ‡æˆè™šçº¿
      }
    });

    // é«˜äº®å±‚ï¼ˆäº‹ä»¶èšç„¦è„‰å†²ï¼‰
    map.addSource("focus-point", { type:"geojson", data: focusFC });
    map.addLayer({
      id:"focus-ring",
      type:"circle",
      source:"focus-point",
      paint:{
        "circle-radius": 10,
        "circle-color": "transparent",
        "circle-stroke-width": 2,
        "circle-stroke-color": "#ff4d4f",
        "circle-opacity": 0.85
      }
    });

    // åˆ›å»ºå•ä½ marker
    for (const u of unitTracks){
      const el = makeUnitEl(u);
      const st = TYPE_STYLE[u.type] || { color:"#aaa" };
      el.style.borderColor = st.color;

      const pts = pointsForUnit(u);
      const pos = positionAt(pts, ms(pts[0].t));
      const marker = new maplibregl.Marker({ element: el }).setLngLat(pos).addTo(map);

      unitMarkers.set(u.id, { marker, el });

      // ç‚¹å‡»å•ä½ï¼šæ—¥å¿—æç¤º + è½»å¾®èšç„¦
      el.addEventListener("click", (ev)=>{
        ev.stopPropagation();
        const ll = marker.getLngLat();
        addLog(`INFOï¼šé€‰æ‹©å•ä½ - ${u.name}`, false);
        map.easeTo({ center:[ll.lng,ll.lat], zoom: Math.max(map.getZoom(), 6), duration: 600 });
        focusPulseAt(ll);
      });
    }

    // åˆå§‹åŒ–æ—¶é—´èŒƒå›´ä¸å½“å‰æ—¶é—´ï¼ˆé»˜è®¤æœ€åä¸€å¤©ï¼‰
    ({ tMin, tMax } = computeRange());
    currentT = tMax;
    timeRangeEl.value = "1000";
    updateAt(currentT);

    // åˆå§‹æ—¥å¿—
    addLog("INFOï¼šç³»ç»Ÿå°±ç»ª - HUD ONLINE", false);
    addLog("INFOï¼šæç¤º - å¯åˆ‡æ¢äº‹å®/æ¨æ¼”å¹¶æ’­æ”¾æ—¶é—´è½´", false);

    // è¿›å…¥ä¸»å¾ªç¯
    loop();
  });

  // åˆ‡æ¢æ¨¡å¼æ—¶ï¼Œéœ€è¦é‡ç®— tMin/tMaxï¼ˆå› ä¸º sim çš„è½¨è¿¹ç‚¹å¯èƒ½ä¸åŒï¼‰
  function refreshRangeAndStay(){
    ({ tMin, tMax } = computeRange());
    currentT = Math.max(tMin, Math.min(currentT, tMax));
    const k = (currentT - tMin)/(tMax - tMin);
    timeRangeEl.value = String(Math.round(k*1000));
    updateAt(currentT);
  }

  // è¦†ç›– setModeï¼šåˆ‡æ¢åé‡ç®—èŒƒå›´
  const _setMode = setMode;
  window.setMode = (m)=>{
    _setMode(m);
    refreshRangeAndStay();
  };

  // è®©æŒ‰é’®åˆ‡æ¢è°ƒç”¨ window.setModeï¼ˆå…¼å®¹ä¸Šé¢è¦†ç›–ï¼‰
  btnFact.onclick = ()=>window.setMode("fact");
  btnSim.onclick  = ()=>window.setMode("sim");
</script>
</body>
</html>
