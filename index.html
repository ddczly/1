<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>态势感知沙盘系统 V3.3 (图例增强版 - 修复版)</title>
    
    <!-- Leaflet CSS (地图核心) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <!-- Font Awesome (图标库) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Tailwind CSS (样式库) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts (机读字体) -->
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* 全局军事风格定义 */
        body {
            font-family: 'Share Tech Mono', 'Noto Sans SC', monospace;
            background-color: #0f1115;
            color: #a3c2c2;
            overflow: hidden;
        }

        /* 模拟 CRT 扫描线效果 */
        .scanlines {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            background-size: 100% 2px, 3px 100%;
            pointer-events: none;
            z-index: 9999;
        }

        /* 地图容器 */
        #map {
            height: 100vh;
            width: 100vw;
            background: #000;
            z-index: 1;
        }

        /* 自定义滑块样式 */
        input[type=range] {
            -webkit-appearance: none;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #00ffcc;
            cursor: pointer;
            margin-top: -6px;
            box-shadow: 0 0 10px #00ffcc;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #334444;
            border-radius: 2px;
        }

        /* V2.0 新增: 战术单位标记样式 */
        .tactical-marker {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 60px !important; 
            height: 60px !important;
            background: transparent !important;
            border: none !important;
        }
        
        .flag-container {
            position: relative;
            width: 40px;
            height: 25px;
            box-shadow: 0 0 10px rgba(0,0,0,0.8);
            border: 1px solid rgba(255,255,255,0.3);
            background: #000;
        }
        
        .flag-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .unit-label {
            margin-top: 2px;
            background: rgba(0, 0, 0, 0.85);
            color: #00ffcc;
            font-size: 10px;
            padding: 1px 4px;
            border: 1px solid #00ffcc;
            border-radius: 2px;
            white-space: nowrap;
            text-shadow: 0 0 2px #000;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.5);
            font-family: 'Noto Sans SC', sans-serif;
        }
        
        .unit-cn .unit-label { color: #ff3333; border-color: #ff3333; }
        .unit-us .unit-label { color: #00ccff; border-color: #00ccff; }
        .unit-jp .unit-label { color: #33ff33; border-color: #33ff33; }

        /* 战术事件弹窗样式 */
        .leaflet-popup-content-wrapper {
            background: rgba(20, 0, 0, 0.9);
            border: 1px solid #ff3333;
            border-radius: 0;
            color: #ffcccc;
            font-family: 'Share Tech Mono', 'Noto Sans SC', monospace;
            box-shadow: 0 0 15px rgba(255, 0, 0, 0.4);
        }
        .leaflet-popup-tip {
            background: #ff3333;
        }
        .event-popup-title {
            color: #ff3333;
            font-weight: bold;
            border-bottom: 1px solid #550000;
            margin-bottom: 4px;
            padding-bottom: 2px;
            font-size: 14px;
            text-transform: uppercase;
        }

        /* V3.2 新增: 路径节点日期标签样式 */
        .node-label {
            background: transparent;
            border: none;
            box-shadow: none;
            color: rgba(255, 255, 255, 0.7);
            font-family: 'Share Tech Mono', monospace;
            font-size: 10px;
            font-weight: bold;
            text-shadow: 1px 1px 0 #000;
        }
        .node-label-cn { color: #ff9999; }
        .node-label-us { color: #99ccff; }
        .node-label-jp { color: #99ff99; }

        /* 玻璃拟态面板 */
        .glass-panel {
            background: rgba(10, 15, 20, 0.85);
            backdrop-filter: blur(4px);
            border: 1px solid rgba(0, 255, 204, 0.2);
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
        }

        /* V3.0 编辑器弹窗样式 */
        .modal-overlay {
            background: rgba(0, 0, 0, 0.9);
            z-index: 99999;
        }
        .json-editor {
            background: #1a1a1a;
            color: #00ffcc;
            font-family: 'Courier New', monospace;
            border: 1px solid #333;
            font-size: 12px;
        }
        .json-editor:focus {
            outline: none;
            border-color: #00ffcc;
            box-shadow: 0 0 10px rgba(0, 255, 204, 0.2);
        }
    </style>
</head>
<body>

    <!-- CRT 滤镜层 -->
    <div class="scanlines"></div>

    <!-- 顶部状态栏 -->
    <div class="fixed top-0 left-0 w-full glass-panel h-12 flex items-center justify-between px-6 z-50 text-xs md:text-sm">
        <div class="flex items-center gap-4">
            <span class="text-emerald-400 font-bold tracking-widest animate-pulse">● 战术态势感知</span>
            <span class="text-gray-500">|</span>
            <span>卫星链路: <span class="text-green-500">在线</span></span>
            <span class="hidden md:inline">|</span>
            <span class="hidden md:inline">战区: 西太平洋 (N10-N45)</span>
        </div>
        <div class="flex items-center gap-4">
            <button onclick="toggleEditor()" class="border border-emerald-500 text-emerald-500 px-3 py-1 hover:bg-emerald-900 transition-colors text-xs font-bold">
                <i class="fas fa-terminal"></i> 数据注入
            </button>
            <span id="system-clock" class="text-xl font-bold text-white">2025-10-01 00:00</span>
        </div>
    </div>

    <!-- 左侧情报面板 -->
    <div class="fixed top-16 left-4 w-64 md:w-80 glass-panel p-4 z-40 rounded-sm hidden md:block">
        <h3 class="text-emerald-400 border-b border-emerald-900 pb-2 mb-2 font-bold flex justify-between">
            <span>情报综述</span>
            <i class="fas fa-radar"></i>
        </h3>
        <div id="unit-details" class="text-sm space-y-3 min-h-[150px]">
            <p class="text-gray-400 italic">>> 点击地图上的单位查看详情...</p>
            <div class="mt-4 border-t border-gray-700 pt-2">
                <div class="text-xs text-gray-500 mb-1">即时战报 (LOG)</div>
                <div class="h-32 overflow-hidden relative">
                    <div id="news-ticker" class="absolute w-full space-y-2 text-xs text-gray-300">
                        <!-- JS populate -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- V3.3 新增: 右侧图例面板 -->
    <div class="fixed top-16 right-4 w-auto glass-panel p-4 z-40 rounded-sm hidden md:block min-w-[180px]">
        <h3 class="text-emerald-400 border-b border-emerald-900 pb-2 mb-3 font-bold text-xs flex justify-between items-center">
            <span>战场识别图例</span>
            <i class="fas fa-list-ul"></i>
        </h3>
        <div id="legend-content" class="space-y-3">
            <!-- JS 将动态填充这里 -->
        </div>
    </div>

    <!-- 底部控制栏 -->
    <div class="fixed bottom-0 left-0 w-full glass-panel p-4 z-50 flex flex-col gap-2">
        <div class="flex justify-between items-end mb-1">
            <div class="text-xs text-emerald-500">推演时间轴控制</div>
            <div class="text-xs text-gray-400">推演速度: <span id="speed-display">1x</span></div>
        </div>
        
        <div class="flex items-center gap-4">
            <button id="play-btn" class="text-emerald-400 hover:text-white transition-colors border border-emerald-900 hover:border-emerald-500 px-4 py-1 rounded">
                <i class="fas fa-play"></i>
            </button>
            <input type="range" id="time-slider" min="0" max="100" value="0" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
            <div class="w-24 text-right text-sm font-bold text-white" id="current-date-display">10/01</div>
        </div>
    </div>

    <!-- 数据编辑器 Modal -->
    <div id="editor-modal" class="hidden fixed inset-0 modal-overlay flex items-center justify-center p-4">
        <div class="bg-gray-900 border border-emerald-500 w-full max-w-4xl h-[80vh] flex flex-col shadow-[0_0_50px_rgba(0,255,204,0.2)]">
            <div class="flex justify-between items-center p-3 border-b border-emerald-900 bg-gray-800">
                <h3 class="text-emerald-400 font-bold"><i class="fas fa-database"></i> 任务数据编辑器</h3>
                <button onclick="toggleEditor()" class="text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
            </div>
            <div class="flex-1 p-4 flex flex-col gap-2">
                <div class="text-xs text-gray-400 mb-1">请粘贴JSON格式的情报数据 (包含 units 和 milestones 数组):</div>
                <textarea id="json-input" class="flex-1 w-full json-editor p-4 rounded"></textarea>
            </div>
            <div class="p-3 border-t border-emerald-900 bg-gray-800 flex justify-end gap-3">
                <button onclick="loadDefaultScenario()" class="px-4 py-2 text-xs text-gray-400 hover:text-white border border-gray-600 hover:border-gray-400">
                    <i class="fas fa-undo"></i> 加载默认演示
                </button>
                <button onclick="processInputData()" class="px-4 py-2 text-xs font-bold text-black bg-emerald-500 hover:bg-emerald-400">
                    <i class="fas fa-upload"></i> 上传并渲染
                </button>
            </div>
        </div>
    </div>

    <!-- 地图容器 -->
    <div id="map"></div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <script>
        // --- 全局变量 ---
        let units = [];
        let milestones = [];
        let START_DATE = new Date("2025-10-01").getTime();
        let END_DATE = new Date("2025-12-15").getTime();
        
        // 动画控制
        let isPlaying = false;
        let animationFrameId;

        // 初始化地图
        const map = L.map('map', {
            zoomControl: false,
            attributionControl: false
        }).setView([25.0, 125.0], 5);

        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            maxZoom: 19,
            subdomains: 'abcd'
        }).addTo(map);

        L.control.scale({ position: 'bottomright' }).addTo(map);

        // --- 默认演示数据 (Template) ---
        const defaultScenario = {
            startDate: "2025-10-01",
            endDate: "2025-12-15",
            milestones: [
                { time: "2025-10-15", lat: 10.5, lng: 112.5, title: "美舰闯入", msg: "DDG-113 进入南沙相关海域" },
                { time: "2025-11-05", lat: 21.0, lng: 121.0, title: "突破岛链", msg: "山东舰编队穿越巴士海峡" },
                { time: "2025-11-08", lat: 24.5, lng: 125.5, title: "抵近侦察", msg: "日方 P-3C 持续跟踪监视" },
                { time: "2025-12-01", lat: 34.5, lng: 129.5, title: "战略通道", msg: "055编队穿越对马海峡" }
            ],
            units: [
                {
                    id: "cn-cv17", shortLabel: "中国 山东舰", type: "Carrier", country: "cn", flagCode: "cn",
                    details: "山东舰航母战斗群。任务：远海实战化对抗演练。",
                    path: [
                        { time: "2025-10-25", lat: 18.2, lng: 109.5 },
                        { time: "2025-11-05", lat: 21.3, lng: 122.0 },
                        { time: "2025-11-20", lat: 20.0, lng: 132.0 },
                        { time: "2025-12-05", lat: 18.2, lng: 109.5 }
                    ]
                },
                {
                    id: "us-ddg", shortLabel: "美国 DDG-113", type: "Destroyer", country: "us", flagCode: "us",
                    details: "伯克级驱逐舰。任务：自由航行行动 (FONOP)。",
                    path: [
                        { time: "2025-10-10", lat: 1.3, lng: 104.0 },
                        { time: "2025-10-15", lat: 10.0, lng: 112.0 },
                        { time: "2025-11-01", lat: 15.0, lng: 118.0 },
                        { time: "2025-11-15", lat: 26.0, lng: 128.0 }
                    ]
                },
                {
                    id: "jp-p3c", shortLabel: "日本 P-3C", type: "Patrol Air", country: "jp", flagCode: "jp",
                    details: "日本海自第5航空群。任务：反潜警戒。",
                    path: [
                        { time: "2025-11-03", lat: 26.2, lng: 127.7 },
                        { time: "2025-11-06", lat: 23.0, lng: 124.0 },
                        { time: "2025-11-12", lat: 26.2, lng: 127.7 }
                    ]
                },
                {
                    id: "cn-055", shortLabel: "中国 055拉萨舰", type: "Destroyer", country: "cn", flagCode: "cn",
                    details: "万吨大驱编队。任务：远海训练。",
                    path: [
                        { time: "2025-11-25", lat: 31.0, lng: 123.0 },
                        { time: "2025-12-01", lat: 34.5, lng: 129.5 },
                        { time: "2025-12-10", lat: 41.0, lng: 132.0 }
                    ]
                }
            ]
        };

        // 填充编辑器默认值
        document.getElementById('json-input').value = JSON.stringify(defaultScenario, null, 4);

        // --- 核心逻辑引擎 ---

        function getCountryColor(code) {
            if(code === 'cn') return '#ff3333';
            if(code === 'us') return '#00ccff';
            if(code === 'jp') return '#33ff33';
            return '#ffff00';
        }

        // V3.3: 动态更新图例
        function updateLegend(units) {
            const container = document.getElementById('legend-content');
            container.innerHTML = '';
            
            // 提取唯一的国家
            const countryMap = new Map();
            units.forEach(u => {
                if (!countryMap.has(u.country)) {
                    countryMap.set(u.country, u.flagCode);
                }
            });

            countryMap.forEach((flagCode, country) => {
                const color = getCountryColor(country);
                const div = document.createElement('div');
                div.className = "flex items-center gap-3 text-xs bg-black/30 p-2 rounded border border-gray-800";
                div.innerHTML = `
                    <div class="w-8 h-5 border border-gray-500 shadow-sm relative overflow-hidden">
                        <img src="https://flagcdn.com/w40/${flagCode}.png" class="w-full h-full object-cover">
                    </div>
                    <div class="flex-1 flex flex-col justify-center">
                        <span class="text-gray-300 font-bold mb-1 leading-none tracking-wide">${country.toUpperCase()}</span>
                        <div class="flex items-center">
                             <div class="h-0.5 w-full" style="background-color: ${color}; box-shadow: 0 0 5px ${color}; opacity: 0.8;"></div>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        // 初始化场景数据
        function initScenario(data) {
            // 1. 清理现有地图元素
            units.forEach(u => {
                if(u.marker) map.removeLayer(u.marker);
                if(u.trail) map.removeLayer(u.trail);
                if(u.plannedTrail) map.removeLayer(u.plannedTrail);
                if(u.nodes) u.nodes.forEach(n => map.removeLayer(n));
            });
            milestones.forEach(m => {
                if(m.popup) map.removeLayer(m.popup);
            });
            
            // 2. 更新时间范围
            if (data.startDate) START_DATE = new Date(data.startDate).getTime();
            if (data.endDate) END_DATE = new Date(data.endDate).getTime();
            
            const slider = document.getElementById('time-slider');
            slider.min = START_DATE;
            slider.max = END_DATE;
            slider.value = START_DATE;

            // 3. 处理 Milestone
            milestones = data.milestones || [];
            milestones.forEach(m => {
                m.timestamp = new Date(m.time).getTime();
                m.popup = L.popup({
                    closeButton: false,
                    autoClose: false,
                    closeOnClick: false,
                    className: 'event-popup'
                })
                .setLatLng([m.lat, m.lng])
                .setContent(`
                    <div class="event-popup-title"><i class="fas fa-exclamation-triangle"></i> ${m.title}</div>
                    <div class="text-xs">${m.msg}</div>
                `);
            });

            // 4. 处理 Units
            units = data.units || [];
            units.forEach(u => {
                // 预处理路径时间戳
                u.path.forEach(p => p.timestamp = new Date(p.time).getTime());
                u.nodes = []; // 存储节点marker

                // V3.2: 绘制完整“计划路径” (背景虚线)
                const fullPathPoints = u.path.map(p => [p.lat, p.lng]);
                u.plannedTrail = L.polyline(fullPathPoints, {
                    color: getCountryColor(u.country),
                    weight: 1,
                    opacity: 0.3,
                    dashArray: '3, 6', // 细虚线
                    interactive: false
                }).addTo(map);

                // V3.2: 绘制关键节点 (带日期标签)
                u.path.forEach(p => {
                    const dateStr = new Date(p.time).toLocaleDateString('zh-CN', {month: '2-digit', day: '2-digit'});
                    
                    // 节点小圆点
                    const nodeMarker = L.circleMarker([p.lat, p.lng], {
                        radius: 2,
                        color: getCountryColor(u.country),
                        fillColor: '#000',
                        fillOpacity: 1,
                        weight: 1,
                        opacity: 0.6
                    }).addTo(map);

                    // 永久显示的日期标签
                    nodeMarker.bindTooltip(dateStr, {
                        permanent: true,
                        direction: 'bottom',
                        className: `node-label node-label-${u.country}`,
                        offset: [0, 5]
                    });
                    
                    u.nodes.push(nodeMarker);
                });
                
                // 创建动态 Unit Marker (初始隐藏)
                const flagUrl = `https://flagcdn.com/w80/${u.flagCode}.png`;
                u.marker = L.marker([0,0], {
                    icon: L.divIcon({
                        className: 'tactical-marker',
                        html: `
                            <div class="flag-container">
                                <img src="${flagUrl}" class="flag-img">
                            </div>
                            <div class="unit-label unit-${u.country}">${u.shortLabel}</div>
                        `,
                        iconSize: [60, 60],
                        iconAnchor: [30, 30]
                    })
                }).bindTooltip(u.details, { 
                    direction: 'top',
                    offset: [0, -20],
                    className: 'bg-black text-white border border-gray-600 font-mono text-xs' 
                });

                // 创建动态轨迹线 (实线/亮虚线)
                u.trail = L.polyline([], {
                    color: getCountryColor(u.country),
                    weight: 2,
                    opacity: 0.8,
                    dashArray: '4, 4' // 动态部分的样式
                }).addTo(map);
            });
            
            // V3.3: 更新图例
            updateLegend(units);
            
            // 重置日志
            document.getElementById('news-ticker').innerHTML = '';
            addLog("系统: 新演习剧本加载成功。");
            
            // 立即刷新一次
            updateSimulation(START_DATE);
        }

        function updateSimulation(currentTime) {
            // Safety Check: 防止无效时间戳导致的计算错误
            if (isNaN(currentTime)) return;

            const dateObj = new Date(currentTime);
            document.getElementById('system-clock').innerText = dateObj.toISOString().replace('T', ' ').substring(0, 16);
            document.getElementById('current-date-display').innerText = `${dateObj.getMonth()+1}/${dateObj.getDate()}`;

            // A. 更新单位位置
            units.forEach(unit => {
                const path = unit.path;
                
                // 检查单位是否存在于该时间段 (需要确保时间戳有效)
                // 注意：计划路径和节点始终显示，只有 Marker 和已走路径会隐藏/显示
                if (path.length === 0 || isNaN(path[0].timestamp) || isNaN(path[path.length-1].timestamp)) return;

                if (currentTime < path[0].timestamp || currentTime > path[path.length-1].timestamp) {
                    if (map.hasLayer(unit.marker)) map.removeLayer(unit.marker);
                    if (map.hasLayer(unit.trail)) map.removeLayer(unit.trail);
                    return;
                }

                if (!map.hasLayer(unit.marker)) unit.marker.addTo(map);
                if (!map.hasLayer(unit.trail)) unit.trail.addTo(map);

                // 插值计算
                let currentPos = null;
                for (let i = 0; i < path.length - 1; i++) {
                    const p1 = path[i];
                    const p2 = path[i+1];
                    
                    // 防御性编程: 确保时间戳有效
                    if (isNaN(p1.timestamp) || isNaN(p2.timestamp)) continue;

                    if (currentTime >= p1.timestamp && currentTime <= p2.timestamp) {
                        const duration = p2.timestamp - p1.timestamp;
                        // 防御性编程: 防止除以零
                        let ratio = 0;
                        if (duration > 0) {
                            ratio = (currentTime - p1.timestamp) / duration;
                        }
                        
                        // 确保 ratio 在 0-1 之间
                        ratio = Math.max(0, Math.min(1, ratio));

                        const lat = p1.lat + (p2.lat - p1.lat) * ratio;
                        const lng = p1.lng + (p2.lng - p1.lng) * ratio;
                        
                        // 只有当坐标有效时才更新
                        if (!isNaN(lat) && !isNaN(lng)) {
                            currentPos = [lat, lng];
                        }
                        break;
                    }
                }

                if (currentPos) {
                    unit.marker.setLatLng(currentPos);
                    unit.marker.setZIndexOffset(1000); 
                    
                    const trailPoints = path.filter(p => p.timestamp <= currentTime).map(p => [p.lat, p.lng]);
                    trailPoints.push(currentPos);
                    unit.trail.setLatLngs(trailPoints);
                }
            });

            // B. 检查关键事件
            milestones.forEach(m => {
                if (isNaN(m.timestamp)) return;
                const timeDiff = currentTime - m.timestamp;
                if (timeDiff >= 0 && timeDiff < 172800000) { // 48小时内显示
                    if (!map.hasLayer(m.popup)) {
                        map.openPopup(m.popup);
                        addLog(`⚠️ 警告: ${m.title} - ${m.msg}`);
                    }
                } else {
                    if (map.hasLayer(m.popup)) {
                        map.closePopup(m.popup);
                    }
                }
            });
        }

        let lastLog = "";
        function addLog(msg) {
            if (msg === lastLog) return;
            lastLog = msg;
            const ticker = document.getElementById('news-ticker');
            const div = document.createElement('div');
            div.className = "border-b border-gray-800 pb-1 text-emerald-400 font-bold";
            if (msg.includes("警告")) div.className = "border-b border-gray-800 pb-1 text-red-400 font-bold";
            div.innerText = "> " + msg;
            ticker.prepend(div);
        }

        // --- 编辑器功能 ---
        function toggleEditor() {
            const el = document.getElementById('editor-modal');
            el.classList.toggle('hidden');
        }

        function loadDefaultScenario() {
            document.getElementById('json-input').value = JSON.stringify(defaultScenario, null, 4);
        }

        function processInputData() {
            const rawText = document.getElementById('json-input').value;
            try {
                const data = JSON.parse(rawText);
                
                // 简单校验
                if (!data.units || !Array.isArray(data.units)) {
                    throw new Error("Invalid JSON: 'units' array missing.");
                }
                
                initScenario(data);
                toggleEditor();
                
            } catch (e) {
                alert("数据解析失败! 请检查JSON格式。\n错误信息: " + e.message);
            }
        }

        // --- 播放控制 ---
        const slider = document.getElementById('time-slider');
        const playBtn = document.getElementById('play-btn');
        const icon = playBtn.querySelector('i');

        slider.addEventListener('input', (e) => {
            const val = parseInt(e.target.value);
            updateSimulation(val);
            if (isPlaying) pauseSimulation();
        });

        playBtn.addEventListener('click', () => {
            if (isPlaying) {
                pauseSimulation();
            } else {
                startSimulation();
            }
        });

        function startSimulation() {
            isPlaying = true;
            icon.className = "fas fa-pause";
            loop();
        }

        function pauseSimulation() {
            isPlaying = false;
            icon.className = "fas fa-play";
            cancelAnimationFrame(animationFrameId);
        }

        function loop() {
            let current = parseInt(slider.value);
            current += 3600000 * 4; // 速度
            
            if (current >= END_DATE) {
                current = START_DATE;
                map.closePopup();
            }

            slider.value = current;
            updateSimulation(current);

            if (isPlaying) {
                animationFrameId = requestAnimationFrame(loop);
            }
        }
        
        // 初始填充一些背景 Log
        const tickerContainer = document.getElementById('news-ticker');
        ["系统: 启动序列完成", "链路: OSINT 数据库已连接", "扫描: 区域 N10-N45 无异常"].forEach(news => {
             const div = document.createElement('div');
             div.className = "border-b border-gray-800 pb-1 text-gray-500";
             div.innerText = "> " + news;
             tickerContainer.appendChild(div);
        });

        // 启动加载
        initScenario(defaultScenario);

    </script>
</body>
</html>
